#!/usr/bin/env bash
set -e -o pipefail
trap 'e=$?; echo 1>&2 "FAILED!"; exit $e' 0

basedir="$(cd "$(dirname "$BASH_SOURCE")" && pwd -P)"
cd "$basedir"
. activate

echo ===== Unit Tests
PYTHONPATH="$basedir/bin" pytest -q t/t[0-9]*.py

echo ===== Functional Tests
export HOME="${basedir}/t/home"
export PATH="${basedir}/bin:$PATH"
. ${basedir}/dot/bashrc.inb4

diff -u <<. - <(cpd -l a p 2>&1)
$HOME/p2/abc
$HOME/p1/abc
$HOME/p2/abc
.

#   Lint pass for 2- vs. 3-isms
python -3 -Qwarnall -W error ${basedir}/bin/cpd.py >/dev/null

trap '' 0
